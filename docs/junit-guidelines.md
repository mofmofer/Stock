# JUnit 整備ガイドライン

本プロジェクトで JUnit テストを拡充する際のルールと運用フローをまとめています。完成済みのテスト群ではなく、開発者が統合開発環境（IDE）や GitLab Duo などの支援機能を活用してテストを書き進めるための共通土台を提供することが目的です。

## テスト設計ポリシー
- **ドメイン単位の検証**: `service` 層と `controller` 層のドメインロジックを優先的にテストします。リポジトリ層はメモリ内データベースを使った統合テストでまとめて担保します。
- **ユースケース指向**: 1 テストクラスにつき 1 ユースケース（例: 入金、出金、取引）に焦点をあて、ハッピーパスと代表的な異常系を用意します。
- **テストデータの明示化**: ビルダーやテスト用ファクトリメソッドを利用し、テストケース内で意図が読み取れるデータを生成します。

## 命名規則
- **クラス名**: `{対象クラス名}Test` を基本とし、ユースケースで分割する場合は `{UseCase}Test`（例: `AccountDepositTest`）。
- **メソッド名**: `メソッド名_条件_期待結果` の形式で日本語か英語のいずれかに統一します。例: `deposit_入金額が正なら残高が加算される()`。
- **表示名**: `@DisplayName` でユーザーストーリーを説明的に記述します。

## IDE を活用したワークフロー
1. **テンプレート生成**: IntelliJ IDEA や Eclipse の「Generate Test」機能でテストクラスの雛形を作成します。GitLab Duo でメソッド毎のテストケース例を提案させ、採用するケースを選別します。
2. **ライブテンプレート**: IDE の Live Template / Postfix Completion を設定し、`given-when-then` コメントや `assertThat` スニペットを高速に挿入します。
3. **自動実行**: IDE の Continuous Testing（IntelliJ の *Rerun Tests on File Save* 等）を有効化し、編集毎に対象テストが即時実行されるようにします。

## GitLab Duo の利用指針
- **プロンプト設計**: 対象クラスの責務、想定シナリオ、異常系条件を箇条書きで提示してテストケースを生成させます。
- **レビュー**: 生成されたテストコードは IDE 上でコンパイルを通し、`assert` の妥当性とサイドエフェクトの有無を確認します。
- **知識の蓄積**: 有用だったプロンプトは `docs/prompts/` などに保存し、メンバーと共有します（フォルダは今後追加予定）。

## テスト実行とフィードバック
- `mvn test` を CI の最小要件とし、ローカルでは IDE のショートカットで個別テスト／クラス単位の実行を行います。
- 長時間かかる統合テストは `@Tag("integration")` を付与し、`mvn test -Dgroups=!integration` などで切り分けられるようにします（タグ付けは段階的に導入）。
- 失敗時には失敗テストを優先修正し、必要に応じて GitLab Duo に原因分析の補助を依頼します。

## コード品質ルール
- **アサーションライブラリ**: AssertJ を標準とし、`assertThat` を用いた可読性の高い検証を行います。
- **テストダブル**: スプリングの `@MockBean` / Mockito を利用し、副作用の大きい依存をスタブ化します。外部 API コールは WireMock などのテストサーバー導入を検討します。
- **テストカバレッジ**: クリティカルなドメインロジックで 80% 以上のステートメントカバレッジを目標にしつつ、カバレッジ数値よりもユースケース網羅を優先します。

## 今後のタスク例
- テスト用ビルダークラスの共通化 (`src/test/java/.../fixtures` ディレクトリの新設)。
- `@Sql` や Testcontainers を使ったデータベース統合テストの導入。
- GitLab Duo プロンプト集のバージョン管理と共有ワークショップの開催。

