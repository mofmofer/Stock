<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>口座管理ダッシュボード</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            color-scheme: light dark;
            font-size: 16px;
            --bg: radial-gradient(circle at top left, #f4f7ff, #eef1ff 40%, #f8f8f8 100%);
            --card-bg: rgba(255, 255, 255, 0.85);
            --text: #1f2544;
            --muted: #626b8a;
            --border: rgba(36, 54, 163, 0.15);
            --accent: #2436a3;
            --danger: #c94a4a;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Noto Sans JP', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 3rem 1.5rem 4rem;
        }

        header {
            max-width: 960px;
            margin: 0 auto 2rem;
            text-align: center;
        }

        header h1 {
            margin: 0 0 0.75rem;
            font-size: clamp(1.9rem, 4vw, 2.8rem);
            font-weight: 700;
        }

        header p {
            margin: 0;
            color: var(--muted);
            line-height: 1.6;
        }

        main {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 18px;
            padding: 1.75rem;
            border: 1px solid var(--border);
            box-shadow: 0 18px 40px rgba(17, 23, 65, 0.08);
            backdrop-filter: blur(10px);
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        button {
            border: none;
            border-radius: 999px;
            padding: 0.65rem 1.4rem;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            background: var(--accent);
            color: #fff;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 22px rgba(36, 54, 163, 0.25);
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .data-section {
            background: rgba(255, 255, 255, 0.65);
            border-radius: 16px;
            padding: 1.25rem 1.25rem 1.5rem;
            border: 1px solid rgba(36, 54, 163, 0.1);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .data-section h2 {
            margin: 0 0 0.25rem;
            font-size: 1.15rem;
            font-weight: 700;
        }

        .data-section p {
            margin: 0 0 1rem;
            font-size: 0.9rem;
            color: var(--muted);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 14px;
            overflow: hidden;
        }

        thead {
            background: rgba(36, 54, 163, 0.08);
        }

        th, td {
            padding: 0.85rem 1rem;
            text-align: left;
            vertical-align: top;
        }

        tbody tr:nth-child(odd) {
            background: rgba(31, 37, 68, 0.04);
        }

        .empty {
            color: var(--muted);
            font-style: italic;
        }

        .updated-at {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.6rem;
            font-size: 0.8rem;
            border-radius: 999px;
            background: rgba(36, 54, 163, 0.12);
            color: var(--accent);
        }

        .numeric {
            text-align: right;
        }

        .log-controls {
            display: flex;
            align-items: flex-end;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .log-controls label {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .log-controls select {
            border: 1px solid rgba(31, 37, 68, 0.18);
            border-radius: 12px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            font-family: inherit;
            min-width: 160px;
        }

        .log-controls button {
            margin-left: auto;
        }

        #accessLogsEmpty {
            margin-top: 0.75rem;
        }

        #accessLogUpdatedAt {
            margin-top: 0.5rem;
        }

        .log-user-agent {
            max-width: 240px;
            word-break: break-word;
        }

        @media (max-width: 720px) {
            main {
                padding: 1.25rem;
            }

            .section-grid {
                grid-template-columns: 1fr;
            }

            table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
<header>
    <h1>口座管理ダッシュボード</h1>
    <p>API 経由で登録されたデータを RDB のテーブルのように俯瞰できます。</p>
</header>
<main>
    <div class="toolbar">
        <div class="updated-at" id="updatedAt">読み込み中...</div>
        <button id="refreshButton">最新の状態に更新</button>
    </div>
    <div class="section-grid">
        <section class="data-section" aria-labelledby="accountsHeading">
            <h2 id="accountsHeading">口座</h2>
            <p>登録済みの口座を一覧できます。</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th>口座 ID</th>
                        <th>名義</th>
                        <th>開設日</th>
                    </tr>
                    </thead>
                    <tbody id="accountTableBody">
                    <tr>
                        <td colspan="3" class="empty">口座情報を取得しています...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <section class="data-section" aria-labelledby="balancesHeading">
            <h2 id="balancesHeading">残高</h2>
            <p>各口座の現金残高を確認できます。</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th>口座 ID</th>
                        <th>名義</th>
                        <th class="numeric">現金残高 (USD)</th>
                    </tr>
                    </thead>
                    <tbody id="balanceTableBody">
                    <tr>
                        <td colspan="3" class="empty">残高情報を取得しています...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <section class="data-section" aria-labelledby="positionsHeading">
            <h2 id="positionsHeading">ポジション</h2>
            <p>各口座の保有銘柄を確認できます。</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th>口座 ID</th>
                        <th>銘柄</th>
                        <th>市場</th>
                        <th class="numeric">保有数量</th>
                        <th class="numeric">平均取得単価</th>
                    </tr>
                    </thead>
                    <tbody id="positionTableBody">
                    <tr>
                        <td colspan="5" class="empty">ポジション情報を取得しています...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <section class="data-section" aria-labelledby="transactionsHeading">
            <h2 id="transactionsHeading">取引履歴</h2>
            <p>各口座の入出金・売買履歴を確認できます。</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th>取引 ID</th>
                        <th>口座 ID</th>
                        <th>種別</th>
                        <th>売買</th>
                        <th>銘柄</th>
                        <th>市場</th>
                        <th class="numeric">数量</th>
                        <th class="numeric">単価</th>
                        <th class="numeric">約定金額</th>
                        <th class="numeric">残高</th>
                        <th>日時</th>
                    </tr>
                    </thead>
                    <tbody id="transactionTableBody">
                    <tr>
                        <td colspan="11" class="empty">取引履歴を取得しています...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <section class="data-section" aria-labelledby="accessLogsHeading">
            <h2 id="accessLogsHeading">アクセスログ</h2>
            <p>ログイン画面や管理画面へのアクセス履歴を監査できます。</p>
            <div class="log-controls">
                <label for="accessLogPageFilter">
                    対象画面
                    <select id="accessLogPageFilter">
                        <option value="ALL">すべて</option>
                    </select>
                </label>
                <button type="button" id="accessLogRefreshButton">ログを更新</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th>時刻</th>
                        <th>画面</th>
                        <th>パス</th>
                        <th>IP アドレス</th>
                        <th>ユーザーエージェント</th>
                    </tr>
                    </thead>
                    <tbody id="accessLogTableBody">
                    <tr>
                        <td colspan="5" class="empty">アクセスログを取得しています...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <p id="accessLogsEmpty" class="empty" style="display: none;">アクセスログはまだありません。</p>
            <div id="accessLogUpdatedAt" class="updated-at"></div>
        </section>
    </div>
</main>
<script>
    const accessLogPageLabels = {
        USER_LOGIN: '利用者ログイン画面',
        ADMIN_LOGIN: '管理者ログイン画面',
        USER_PORTAL: '利用者トップ画面',
        ADMIN_DASHBOARD: '管理者ダッシュボード'
    };

    async function logAccess(pageName) {
        try {
            await fetch('/api/access-logs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ page: pageName, path: window.location.pathname })
            });
        } catch (error) {
            console.warn('アクセスログの送信に失敗しました', error);
        }
    }

    async function loadDashboard() {
        setLoading(true);
        resetTables();
        try {
            const accounts = await fetchAccounts();
            renderAccountTable(accounts);
            renderBalanceTable(accounts);
            renderPositionTable(accounts);
            await renderTransactionTable(accounts);
            const updatedAt = new Date();
            document.getElementById('updatedAt').textContent = `最終更新: ${updatedAt.toLocaleString('ja-JP')}`;
        } catch (error) {
            renderGlobalError(error.message);
        } finally {
            setLoading(false);
        }
    }

    async function fetchAccounts() {
        const response = await fetch('/api/accounts');
        if (!response.ok) {
            throw new Error(await response.text() || response.statusText);
        }
        return response.json();
    }

    function renderAccountTable(accounts) {
        const tbody = document.getElementById('accountTableBody');
        tbody.innerHTML = '';
        if (!accounts.length) {
            tbody.appendChild(createEmptyRow(3, '登録済みの口座はまだありません。'));
            return;
        }
        for (const account of accounts) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><code>${account.id}</code></td>
                <td>${escapeHtml(account.ownerName)}</td>
                <td>${formatDate(account.createdAt)}</td>
            `;
            tbody.appendChild(row);
        }
    }

    function renderBalanceTable(accounts) {
        const tbody = document.getElementById('balanceTableBody');
        tbody.innerHTML = '';
        if (!accounts.length) {
            tbody.appendChild(createEmptyRow(3, '残高情報がありません。'));
            return;
        }
        for (const account of accounts) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><code>${account.id}</code></td>
                <td>${escapeHtml(account.ownerName)}</td>
                <td class="numeric">${formatCurrency(account.cashBalance)}</td>
            `;
            tbody.appendChild(row);
        }
    }

    function renderPositionTable(accounts) {
        const tbody = document.getElementById('positionTableBody');
        tbody.innerHTML = '';
        const positionRows = [];
        for (const account of accounts) {
            for (const holding of account.holdings || []) {
                positionRows.push({ accountId: account.id, holding });
            }
        }
        if (!positionRows.length) {
            tbody.appendChild(createEmptyRow(5, '現在の保有ポジションはありません。'));
            return;
        }
        for (const { accountId, holding } of positionRows) {
            const row = document.createElement('tr');
            const quantity = Number(holding.quantity ?? 0).toLocaleString('en-US');
            const avgCost = Number(holding.averageCost ?? 0).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 4
            });
            row.innerHTML = `
                <td><code>${accountId}</code></td>
                <td><span class="badge">${escapeHtml(holding.symbol ?? '')}</span></td>
                <td>${escapeHtml(holding.exchange ?? '')}</td>
                <td class="numeric">${quantity}</td>
                <td class="numeric">$${avgCost}</td>
            `;
            tbody.appendChild(row);
        }
    }

    async function renderTransactionTable(accounts) {
        const tbody = document.getElementById('transactionTableBody');
        tbody.innerHTML = '';
        if (!accounts.length) {
            tbody.appendChild(createEmptyRow(11, '取引履歴を表示する口座がありません。'));
            return;
        }
        tbody.appendChild(createEmptyRow(11, '取引履歴を取得しています...'));
        try {
            const transactions = await fetchTransactions(accounts);
            tbody.innerHTML = '';
            if (!transactions.length) {
                tbody.appendChild(createEmptyRow(11, '取引履歴はまだありません。'));
                return;
            }
            for (const tx of transactions) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${tx.id}</td>
                    <td><code>${tx.accountId}</code></td>
                    <td>${formatTransactionType(tx.type)}</td>
                    <td>${formatTradeSide(tx.tradeSide)}</td>
                    <td>${escapeHtml(tx.symbol ?? '')}</td>
                    <td>${escapeHtml(tx.exchange ?? '')}</td>
                    <td class="numeric">${formatNumber(tx.quantity)}</td>
                    <td class="numeric">${formatCurrency(tx.pricePerShare)}</td>
                    <td class="numeric">${formatCurrency(tx.grossAmount ?? tx.cashAmount)}</td>
                    <td class="numeric">${formatCurrency(tx.cashBalanceAfter)}</td>
                    <td>${formatDateTime(tx.occurredAt)}</td>
                `;
                tbody.appendChild(row);
            }
        } catch (error) {
            tbody.innerHTML = '';
            tbody.appendChild(createEmptyRow(11, `取引履歴の取得に失敗しました: ${escapeHtml(error.message)}`));
        }
    }

    async function fetchTransactions(accounts) {
        const requests = accounts.map(async (account) => {
            const response = await fetch(`/api/accounts/${account.id}/transactions`);
            if (!response.ok) {
                throw new Error(await response.text() || response.statusText);
            }
            const transactions = await response.json();
            return transactions.map((tx) => ({ ...tx, accountId: account.id }));
        });
        const results = await Promise.all(requests);
        return results.flat().sort((a, b) => new Date(b.occurredAt) - new Date(a.occurredAt));
    }

    async function fetchAccessLogPages() {
        const response = await fetch('/api/access-logs/pages');
        if (!response.ok) {
            throw new Error(await response.text() || response.statusText);
        }
        return response.json();
    }

    async function populateAccessLogFilter() {
        const select = document.getElementById('accessLogPageFilter');
        if (!select) {
            return;
        }
        const previousValue = select.value || 'ALL';
        try {
            const pages = await fetchAccessLogPages();
            const candidates = ['ALL', ...pages.filter((page) => typeof page === 'string')];
            select.innerHTML = '';
            for (const page of candidates) {
                const option = document.createElement('option');
                option.value = page;
                option.textContent = page === 'ALL' ? 'すべて' : formatAccessLogPage(page);
                select.appendChild(option);
            }
            if (candidates.includes(previousValue)) {
                select.value = previousValue;
            }
        } catch (error) {
            console.warn('アクセスログ対象ページの取得に失敗しました', error);
            if (!Array.from(select.options).some((option) => option.value === 'ALL')) {
                const option = document.createElement('option');
                option.value = 'ALL';
                option.textContent = 'すべて';
                select.appendChild(option);
            }
            select.value = 'ALL';
        }
    }

    async function loadAccessLogs({ showLoading = true } = {}) {
        const tbody = document.getElementById('accessLogTableBody');
        const emptyMessage = document.getElementById('accessLogsEmpty');
        const updatedAtEl = document.getElementById('accessLogUpdatedAt');
        const select = document.getElementById('accessLogPageFilter');
        if (!tbody || !emptyMessage) {
            return;
        }

        const params = new URLSearchParams({ limit: '100' });
        const selectedPage = select ? select.value : 'ALL';
        if (selectedPage && selectedPage !== 'ALL') {
            params.set('page', selectedPage);
        }

        if (showLoading) {
            tbody.innerHTML = '';
            tbody.appendChild(createEmptyRow(5, 'アクセスログを取得しています...'));
            emptyMessage.style.display = 'none';
        }

        try {
            const response = await fetch(`/api/access-logs?${params.toString()}`);
            if (!response.ok) {
                throw new Error(await response.text() || response.statusText);
            }
            const logs = await response.json();
            renderAccessLogTable(logs);
            if (!logs.length) {
                emptyMessage.style.display = 'block';
            } else {
                emptyMessage.style.display = 'none';
            }
            if (updatedAtEl) {
                updatedAtEl.textContent = `最終取得: ${new Date().toLocaleString('ja-JP')}`;
            }
        } catch (error) {
            tbody.innerHTML = '';
            tbody.appendChild(createEmptyRow(5, `アクセスログの取得に失敗しました: ${escapeHtml(error.message)}`));
            if (emptyMessage) {
                emptyMessage.style.display = 'none';
            }
            if (updatedAtEl) {
                updatedAtEl.textContent = '';
            }
        }
    }

    function renderAccessLogTable(logs) {
        const tbody = document.getElementById('accessLogTableBody');
        if (!tbody) {
            return;
        }
        tbody.innerHTML = '';
        if (!Array.isArray(logs) || !logs.length) {
            return;
        }
        for (const log of logs) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDateTime(log.accessedAt)}</td>
                <td>${escapeHtml(formatAccessLogPage(log.page))}</td>
                <td><code>${escapeHtml(log.path ?? '')}</code></td>
                <td>${escapeHtml(log.ipAddress ?? '-')}</td>
                <td class="log-user-agent">${escapeHtml(log.userAgent ?? '-')}</td>
            `;
            tbody.appendChild(row);
        }
    }

    function formatAccessLogPage(page) {
        if (!page) {
            return '-';
        }
        return accessLogPageLabels[page] || page;
    }

    function createEmptyRow(colspan, message) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="${colspan}" class="empty">${escapeHtml(message)}</td>`;
        return row;
    }

    function renderGlobalError(message) {
        document.getElementById('updatedAt').textContent = '最新情報を取得できませんでした';
        document.getElementById('accountTableBody').innerHTML = '';
        document.getElementById('accountTableBody').appendChild(createEmptyRow(3, `エラーが発生しました: ${escapeHtml(message)}`));
        document.getElementById('balanceTableBody').innerHTML = '';
        document.getElementById('balanceTableBody').appendChild(createEmptyRow(3, `エラーが発生しました: ${escapeHtml(message)}`));
        document.getElementById('positionTableBody').innerHTML = '';
        document.getElementById('positionTableBody').appendChild(createEmptyRow(5, `エラーが発生しました: ${escapeHtml(message)}`));
        document.getElementById('transactionTableBody').innerHTML = '';
        document.getElementById('transactionTableBody').appendChild(createEmptyRow(11, `エラーが発生しました: ${escapeHtml(message)}`));
    }

    function resetTables() {
        const accountBody = document.getElementById('accountTableBody');
        accountBody.innerHTML = '';
        accountBody.appendChild(createEmptyRow(3, '口座情報を取得しています...'));

        const balanceBody = document.getElementById('balanceTableBody');
        balanceBody.innerHTML = '';
        balanceBody.appendChild(createEmptyRow(3, '残高情報を取得しています...'));

        const positionBody = document.getElementById('positionTableBody');
        positionBody.innerHTML = '';
        positionBody.appendChild(createEmptyRow(5, 'ポジション情報を取得しています...'));

        const transactionBody = document.getElementById('transactionTableBody');
        transactionBody.innerHTML = '';
        transactionBody.appendChild(createEmptyRow(11, '取引履歴を取得しています...'));
    }

    function formatDate(value) {
        if (!value) {
            return '-';
        }
        return new Date(value).toLocaleDateString('ja-JP');
    }

    function formatDateTime(value) {
        if (!value) {
            return '-';
        }
        return new Date(value).toLocaleString('ja-JP');
    }

    function formatNumber(value) {
        if (value === null || value === undefined) {
            return '-';
        }
        return Number(value).toLocaleString('en-US');
    }

    function formatCurrency(value) {
        if (value === null || value === undefined) {
            return '-';
        }
        const number = Number(value ?? 0);
        return number.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    }

    function formatTransactionType(type) {
        switch (type) {
            case 'DEPOSIT':
                return '入金';
            case 'WITHDRAWAL':
                return '出金';
            case 'TRADE':
                return '売買';
            default:
                return '-';
        }
    }

    function formatTradeSide(side) {
        switch (side) {
            case 'BUY':
                return '買い';
            case 'SELL':
                return '売り';
            default:
                return '-';
        }
    }

    function setLoading(isLoading) {
        const button = document.getElementById('refreshButton');
        button.disabled = isLoading;
        button.textContent = isLoading ? '更新中...' : '最新の状態に更新';
    }

    function escapeHtml(text = '') {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text.replace(/[&<>"']/g, (m) => map[m]);
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const refreshButton = document.getElementById('refreshButton');
        if (refreshButton) {
            refreshButton.addEventListener('click', async () => {
                await loadDashboard();
                await loadAccessLogs({ showLoading: true });
            });
        }

        const accessLogRefreshButton = document.getElementById('accessLogRefreshButton');
        if (accessLogRefreshButton) {
            accessLogRefreshButton.addEventListener('click', () => loadAccessLogs({ showLoading: true }));
        }

        const accessLogPageFilter = document.getElementById('accessLogPageFilter');
        if (accessLogPageFilter) {
            accessLogPageFilter.addEventListener('change', () => loadAccessLogs({ showLoading: true }));
        }

        logAccess('ADMIN_DASHBOARD');
        await populateAccessLogFilter();
        await loadDashboard();
        await loadAccessLogs({ showLoading: true });
    });
</script>
</body>
</html>
